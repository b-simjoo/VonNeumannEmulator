const t={LED_SIG_LOADM:["path562","path1370"],LED_SIG_LOADAR:["path570","path1378"],LED_SIG_LOADPC:["path1100","path1558"],LED_SIG_ENPC:["path586","path1394"],LED_SIG_LOADDR:["path594","path1402"],LED_SIG_LOADAC:["path1452","path1410-4"],LED_SIG_LOADINPR:null,LED_SIG_LOADTR:null,LED_SIG_LOADIR:["path618","path1426"],LED_SIG_LOADOUTR:null,LED_SIG_ADD_T4:"path978",LED_SIG_AND_T4:"path986",LED_SIG_COMP_T2:"path994",LED_SIG_LSL_T2:"path1002",LED_SIG_LOAD_T4:"path1010",LED_COMBUS_MUX:["ellipse892","ellipse894","ellipse896","ellipse898","ellipse900","ellipse902","ellipse904","ellipse906"],LED_INC_DEC:["ellipse1218","ellipse1210","ellipse1202","ellipse1194","ellipse1186","ellipse1178","ellipse1170","ellipse1162"],LED_SEQ_DEC:["ellipse1240","ellipse1248","ellipse1256","ellipse1264","ellipse1272","ellipse1280","ellipse1288","ellipse1296"],LED_SIG_RSTSC:["ellipse1314","ellipse1322"],LED_Z:["ellipse1338","ellipse1062"],LED_CLK:["path230","path268","path306","path350","path398","path438","path476","path514","path554","path1306"],NUM_MEM_OUT:"text788",NUM_MEM_DATA:"text636",NUM_AR_DATA:"text644",NUM_AR_VALUE:"text260",NUM_AR_OUT:null,NUM_PC_DATA:"text654",NUM_PC_VALUE:"text298",NUM_PC_OUT:null,NUM_DR_DATA:"text734",NUM_DR_VALUE:"text342",NUM_DR_OUT:null,NUM_AC_VALUE:"text390",NUM_AC_OUT:"text1072",NUM_ALU_FUNCNUM:"text770",TXT_ALU_FUNC:"text762",NUM_ALU_OUT:"text662",NUM_IR_DATA:"text718",NUM_IR_VALUE:"text506",NUM_IR_OUT:"text1228",NUM_TR_DATA:"text710",NUM_OUTR_DATA:"text726",NUM_SC_VALUE:"text1478",NUM_COMMON_BUS_VALUE:"text912",NUM_COMMON_BUS_SELECT:["text1364","text1356"]};function e(t,e=4){return(t||0).toString(16).padStart(e,"0")}class s{onOutputChange=null;_output=0;constructor(t){this.diagram=t}get output(){return this._output}set output(t){this._output!==t&&(this._output=t,this.onOutputChanged(),this.onOutputChange?.(t))}}class i extends s{_select=0;constructor(t,e,s,i,n=8){super(t),this.outNUM=e,this.selectNUM=s,this.inputsLEDs=i,this.inputs=Array(n),this.update(),this.onOutputChanged()}set select(t){this._select=t,this.selectNUM&&this.diagram.dig_write(this.selectNUM,this._select,1),this.inputsLEDs?.forEach(((t,e)=>{this.select==e?this.diagram.high(t):this.diagram.low(t)})),this.output=this.inputs[t]||0}get select(){return this._select}setInput(t,e){this.inputs[t]=e}update(){this.output=this.inputs[this._select]||0}onOutputChanged(){this.outNUM&&this.diagram.dig_write(this.outNUM,this.output,4)}}class n extends s{WE=!1;data=0;onArrayChange=null;_addr=0;constructor(t,e,s=4096){super(t),this.outputNUM=e,this._memArray=Array(s),this.onOutputChanged()}get memArray(){return this._memArray}set memArray(t){this._memArray=t,this.output=this._memArray[this._addr]||0}set addr(t){this._addr=t,this.output=this.memArray[t]||0}tick(){this.output=this.memArray[this._addr]||0,this.WE&&(console.log("writing to memory,  address: "+this._addr+" data: "+this.data),this.memArray[this._addr]=this.data,this.onArrayChange?.(this,this._addr||0,this.data||0))}onOutputChanged(){this.outputNUM&&this.diagram.dig_write(this.outputNUM,this.output,4)}}class h extends s{load=!1;rst=!1;data=0;value=0;constructor(t,e,s,i,n=!1,h=16){super(t),this.name=e,this.en=n,this.maximum=Math.pow(2,h),this.nibbleCount=Math.ceil(h/4),this.valueNUM=s,this.outputNUM=i,this.onOutputChanged()}tick(){let t=this.value;this.load&&(this.value=this.data),this.en&&(this.value=(this.value+1)%this.maximum),this.rst&&(this.value=0),console.log(this.name+" Value:"+e(this.value)+", Data:"+e(this.data)+" "+e(t)+"=>"+e(this.value)+"  [load:"+(this.load?1:0)+", en:"+(this.en?1:0)+", rst:"+(this.rst?1:0)+"]"),this.output=this.value}onOutputChanged(){this.valueNUM&&this.diagram.dig_write(this.valueNUM,this.value,this.nibbleCount),this.outputNUM&&this.diagram.dig_write(this.outputNUM,this.output,this.nibbleCount)}}class o extends h{constructor(t,e,s,i,n=16){super(t,e,s,i,!0,n)}}class a extends s{_portA=0;_portB=0;_func=0;functions=[(t,e)=>t+e,(t,e)=>t&e,(t,e)=>~t,(t,e)=>t<<1,(t,e)=>e];functionNames=["ADD","AND","NOT","LSL","---"];constructor(t,e,s){super(t),this.outNUM=e,this.funcName=s,this.onOutputChanged()}set portA(t){this._portA=t,this.output=this.functions[this._func](this._portA,this._portB)}set portB(t){this._portB=t,this.output=this.functions[this._func](this._portA,this._portB)}set func(t){this._func=t,this.funcName&&this.diagram.changeText(this.funcName,"func: "+this.functionNames[this._func]),this.output=this.functions[this._func](this._portA,this._portB)}onOutputChanged(){this.outNUM&&this.diagram.dig_write(this.outNUM,this.output,4)}}class l extends s{constructor(t,e,s){super(t),this.outputLEDs=e,e&&this.diagram.high(e[0]),s.forEach(((t,e)=>Object.defineProperty(this,t,{get(){return this.output===e}}))),this.onOutputChanged()}set input(t){this.output=t}onOutputChanged(){this.outputLEDs?.forEach(((t,e)=>{this.output==e?this.diagram.high(t):this.diagram.low(t)}))}}class u extends s{constructor(t,e,s,i=5){super(t),this.inputLEDIds=e,this.outNum=s,this.nibbleCount=Math.ceil(i/16),this.inputs=Array(i),this.onOutputChanged()}setInput(t,e){this.inputs[t]=e;for(let t=0;t<this.inputs.length;t++)if(this.inputs[t])return void(this.output=t);this.output=0}onOutputChanged(){this.inputLEDIds?.forEach(((t,e)=>{this.inputs[e]?this.diagram.high(t):this.diagram.low(t)})),this.outNum&&this.diagram.dig_write(this.outNum,this.output,this.nibbleCount)}}class c{ledGreen="#00FF00";ledGray="#E6E6E6";CLKup=!1;ACZ=!0;constructor(e){this.diagramSVG=e,this.Mem=new n(this,t.NUM_MEM_OUT,4096),this.AR=new h(this,"AR",t.NUM_AC_VALUE,t.NUM_AC_OUT,!1,12),this.PC=new h(this,"PC",t.NUM_PC_VALUE,t.NUM_PC_OUT,!1,12),this.DR=new h(this,"DR",t.NUM_DR_VALUE,t.NUM_DR_OUT,!1,16),this.ALU=new a(this,t.NUM_ALU_OUT,t.TXT_ALU_FUNC),this.AC=new h(this,"AC",t.NUM_AC_VALUE,t.NUM_AC_OUT,!1,16),this.IR=new h(this,"IR",t.NUM_IR_VALUE,null,!1,16),this.CommonBus=new i(this,[t.NUM_COMMON_BUS_VALUE,t.NUM_MEM_DATA,t.NUM_AR_DATA,t.NUM_PC_DATA,t.NUM_DR_DATA,t.NUM_TR_DATA,t.NUM_IR_DATA,t.NUM_OUTR_DATA],t.NUM_COMMON_BUS_SELECT,t.LED_COMBUS_MUX,8),this.ALUEncoder=new u(this,null,t.NUM_ALU_FUNCNUM,5),this.SeqDec=new l(this,t.LED_SEQ_DEC,["T0","T1","T2","T3","T4","T5","T6","T7"]),this.IncDec=new l(this,t.LED_INC_DEC,["load","store","add","and","jump","jumpz","comp","lsl"]),this.SC=new o(this,"SC",null,t.NUM_SC_VALUE,3),this.Mem.onOutputChange=t=>{console.log("mem output changed=>"+t),this.CommonBus.setInput(0,t)},this.Mem.onArrayChange=t=>{},this.AR.onOutputChange=t=>{this.Mem.addr=t,this.CommonBus.setInput(1,t)},this.PC.onOutputChange=t=>this.CommonBus.setInput(2,t),this.DR.onOutputChange=t=>{this.ALU.portB=t,this.CommonBus.setInput(3,t)},this.ALU.onOutputChange=t=>this.AC.data=t,this.ALUEncoder.onOutputChange=t=>this.ALU.func=t,this.AC.onOutputChange=e=>{this.ALU.portA=e,this.CommonBus.setInput(4,e),this.ACZ=this.signalLED(t.LED_Z,0===e)},this.IR.onOutputChange=e=>{this.CommonBus.setInput(7,e);let s=Math.floor(e/Math.pow(2,12))%Math.pow(2,16);this.IncDec.input=s,this.dig_write(t.NUM_IR_OUT,s,1)},this.SC.onOutputChange=t=>this.SeqDec.input=t,this.IncDec.onOutputChange=t=>{},this.SeqDec.onOutputChange=t=>{},this.CommonBus.onOutputChange=t=>{console.log("commonBus output changed =>"+t),[this.Mem,this.DR,this.IR].forEach((e=>{e.data=t})),this.AR.data=t%Math.pow(2,12),this.PC.data=t%Math.pow(2,12)},this.signalLED(t.LED_CLK,this.CLKup)}signals(){this.CommonBus.select=this.SeqDec.T1||this.SeqDec.T3&&this.IncDec.load||this.IncDec.Add&&this.SeqDec.T2||this.IncDec.And&&this.SeqDec.T3?0:this.SeqDec.T0?2:this.IncDec.store&&this.SeqDec.T3?4:this.SeqDec.T2&&(this.IncDec.load||this.IncDec.store||this.IncDec.add||this.IncDec.jump||this.IncDec.jumpz&&this.ACZ)?7:0,this.CommonBus.update(),console.log("common bus select: "+this.CommonBus.select),this.enPC=this.SeqDec.T0,this.loadAC=this.IncDec.load&&this.SeqDec.T4||this.IncDec.add&&this.SeqDec.T4||this.IncDec.and&&this.SeqDec.T4||this.IncDec.comp&&this.SeqDec.T2||this.IncDec.lsl&&this.SeqDec.T2,this.loadM=this.IncDec.store&&this.SeqDec.T3,this.loadAR=this.IncDec.load&&this.SeqDec.T2||this.IncDec.store&&this.SeqDec.T2||this.IncDec.add&&this.SeqDec.T2||this.IncDec.and&&this.SeqDec.T3||this.SeqDec.T0,this.loadPC=this.SeqDec.T2&&(this.IncDec.jump||this.IncDec.jumpz&&this.ACZ),this.loadDR=this.SeqDec.T3&&(this.IncDec.load||this.IncDec.add||this.IncDec.And),this.loadIR=this.SeqDec.T1,this.rstSC=this.IncDec.load&&this.SeqDec.T4||this.IncDec.store&&this.SeqDec.T3||this.IncDec.add&&this.SeqDec.T4||this.IncDec.and&&this.SeqDec.T4||this.IncDec.comp&&this.SeqDec.T2||this.IncDec.lsl&&this.SeqDec.T2||this.IncDec.jump&&this.SeqDec.T2||this.IncDec.jumpz&&this.SeqDec.T2,this.ALUEncoder.setInput(0,this.signalLED(t.LED_SIG_ADD_T4,this.IncDec.add&&this.SeqDec.T4)),this.ALUEncoder.setInput(1,this.signalLED(t.LED_SIG_AND_T4,this.IncDec.and&&this.SeqDec.T4)),this.ALUEncoder.setInput(2,this.signalLED(t.LED_SIG_COMP_T2,this.IncDec.comp&&this.SeqDec.T2)),this.ALUEncoder.setInput(3,this.signalLED(t.LED_SIG_LSL_T2,this.IncDec.lsl&&this.SeqDec.T2)),this.ALUEncoder.setInput(4,this.signalLED(t.LED_SIG_LOAD_T4,this.IncDec.load&&this.SeqDec.T4))}tick(){this.signals(),this.tickRegisters(),this.signals()}tickRegisters(){[this.Mem,this.AR,this.PC,this.DR,this.AC,this.IR,this.SC].forEach((t=>{t.tick()}))}get(t){return this.diagramSVG.getElementById(t)}high(t){Array.isArray(t)?t.forEach((t=>this.high(t))):this.get(t)?.setAttribute("fill",this.ledGreen)}low(t){Array.isArray(t)?t.forEach((t=>this.low(t))):this.get(t)?.setAttribute("fill",this.ledGray)}changeText(t,e){if(Array.isArray(t))return void t.forEach((t=>this.changeText(t,e)));let s=this.get(t);if(null!=s&&(s.innerHTML=e,"foreignObject"===s.previousElementSibling?.tagName)){let t=s.previousElementSibling;for(;t.childElementCount;)t=t.children[0];t.innerHTML=e}}loadMemArray(t){this.Mem.memArray=t}dig_write(t,s,i=4){let n=e(s,i);this.changeText(t,n)}set loadM(e){this.Mem.WE=e,this.signalLED(t.LED_SIG_LOADM,e),console.log("loadM: "+e)}set loadAR(e){this.AR.load=e,this.signalLED(t.LED_SIG_LOADAR,e),console.log("loadAR: "+e)}set loadPC(e){this.PC.load=e,this.signalLED(t.LED_SIG_LOADPC,e),console.log("loadPC: "+e)}set enPC(e){this.PC.en=e,this.signalLED(t.LED_SIG_ENPC,e),console.log("enPC: "+e)}set loadDR(e){this.DR.load=e,this.signalLED(t.LED_SIG_LOADDR,e),console.log("loadDR: "+e)}set loadAC(e){this.AC.load=e,this.signalLED(t.LED_SIG_LOADAC,e),console.log("loadAC: "+e)}set loadIR(e){this.IR.load=e,this.signalLED(t.LED_SIG_LOADIR,e),console.log("loadIR: "+e)}set rstSC(e){this.SC.rst=e,this.signalLED(t.LED_SIG_RSTSC,e),console.log("rstSC: "+e)}signalLED(t,e){return e?this.high(t):this.low(t),e}}const r=t=>{for(const e of t.children){const t=e.innerText.replace(/(\/\/.*)/g,"<span class='comment'>$1</span>").replace(/\b(load|store|add|and|jump|jumpz)(\s+)(\d+)/g,"<span class='func'>$1</span>$2<span class='param'>$3</span>").replace(/\b(comp|lsl)/g,"<span class='func'>$1</span>").replace(/^(\d+)/g,"<span class='number'>$1</span>");e.innerHTML=t.split("\n").join("<br/>")}},d=(t,e=r,s="    ")=>{const i=()=>{const e=window.getSelection().getRangeAt(0),s=e.cloneRange();return s.selectNodeContents(t),s.setEnd(e.endContainer,e.endOffset),s.toString().length},n=(e,s=t)=>{for(const t of s.childNodes)if(t.nodeType==Node.TEXT_NODE){if(t.length>=e){const s=document.createRange(),i=window.getSelection();return s.setStart(t,e),s.collapse(!0),i?.removeAllRanges(),i?.addRange(s),-1}e-=t.length}else if((e=n(e,t))<0)return e;return e};e(t),t.addEventListener("keydown",(h=>{if("Tab"===h.code){const o=i()+s.length,a=window.getSelection()?.getRangeAt(0);a?.deleteContents(),a?.insertNode(document.createTextNode(s)),e(t),n(o),h.preventDefault()}})),t.addEventListener("keyup",(s=>{if(s.keyCode>=48||32==s.keyCode){const s=i();e(t),n(s)}}))};let p,_,D,m,A,C=1,g=["load","store","add","and","jump","jumpz","comp","lsl"],T=[["T0: AR <- PC, PC <- PC+1","T1: IR <- Mem[AR]","Load.T2: AR <- IR[11:0]","Load.T3: DR <- Mem[AR]","Load.T4: AC <- DR, SC <- 0"],["T0: AR <- PC, PC <- PC+1","T1: IR <- Mem[AR]","Store.T2: AR <- IR[11:0]","Store.T3: Mem[AR] <- AC, SC <- 0"],["T0: AR <- PC, PC <- PC+1","T1: IR <- Mem[AR]","Add.T2: AR <- IR[11:0]","Add.T2: DR <- Mem[AR]","Add.T4: AC <- AC+DR, SC <- 0"],["T0: AR <- PC, PC <- PC+1","T1: IR <- Mem[AR]","And.T2: AR <- IR[11:0]","And.T3: DR <- Mem[AR]","And.T4: AC <- AC & DR, SC <- 0"],["T0: AR <- PC, PC <- PC+1","T1: IR <- Mem[AR]","Jump.T2: PC <- IR[11:0], SC <- 0"],["T0: AR <- PC, PC <- PC+1","T1: IR <- Mem[AR]","Jumpz.T2.z: PC <- IR[11:0], Jumpz.T2: SC <- 0"],["T0: AR <- PC, PC <- PC+1","T1: IR <- Mem[AR]","Comp.T3: AC <- ~AC, SC <- 0"],["T0: AR <- PC, PC <- PC+1","T1: IR <- Mem[AR]","LSL.T2: AC <- LSL(AC), SC <- 0"]],E=/^\s*(load|store|add|and|jump|jumpz)\s*(\d+)\s*(?:\/\/.*)?$/,L=/^\s*(comp|lsl)\s*(?:\/\/.*)?$/,I=/^\s*(\d+)\s*(?:\/\/.*)?$/,M=/^\s*(?:\/\/.*)?$/;function U(t,...e){let s;return"string"==typeof t?s=document.createElement(t):(s=document.createElement(t.tagName),s.classList.add(...t.cls)),e.forEach((t=>{"function"==typeof t?s.append(...t()):s.append(t)})),s}function S(){D?.remove(),D=U("table",(()=>{let t=[U("thead",(()=>{let t=U("td","Memory");return t.setAttribute("colspan","2"),[t]}))];for(let s=0;s<4095;s+=C)t.push(U("tr",U({tagName:"td",cls:["addr"]},e(s,3)),(()=>{let t=[];for(let i=0;i<C;i++)t.push(U({tagName:"td",cls:p.Mem.memArray[s+i]?["data"]:["data","zero"]},e(p.Mem.memArray[s+i])));return t})));return t})),document.getElementById("memory")?.append(D),p.Mem.onArrayChange=(t,s,i)=>{let n=D?.childNodes[Math.floor(s/C)+1],h=n?.childNodes[1];n.classList.add("changed"),i?h.classList.remove("zero"):h.classList.add("zero"),h.innerText=e(i,4),n?.scrollIntoView({block:"center"}),setTimeout((()=>{n.classList.remove("changed")}),5e3)},m&&(m.innerText="Memory cleared, Click Compile to load program")}function R(){let t=Array();_?.childNodes.forEach((e=>{e.nodeType!==Node.TEXT_NODE&&("\n"!==e.innerText?t.push(e.innerText):t.push(""))}));let[e,s]=function(t){let e=new Array(4096);for(let s=0;s<t.length;s++){let i=t[s],n=0;if(E.test(i)){let t=i.match(E);n=(g.indexOf(t[1])<<12)+parseInt(t[2])}else if(L.test(i)){let t=i.match(L);n=g.indexOf(t[1])<<12}else if(I.test(i))n=parseInt(i.match(I)[1]);else{if(!M.test(i))return[!1,s];n=0}e[s]=n}return[!0,e]}(t);return e?(p.loadMemArray(s),S(),m&&(m.innerText="Ready. Click Run to start")):(console.error(`Error at line: ${s}`),m&&(m.innerText=`Error at line: ${s}`)),e}function N(){p.tick(),m&&(m.innerText=T[p.IncDec.output][p.SeqDec.output])}function f(){document.getElementById("btn-pause").disabled=!0,clearTimeout(A)}let O=1e3;const y=window.innerHeight;window.addEventListener("load",(function(){document.body.style.height=y.toString()+"px",console.clear();let t=document.getElementById("diagram")?.contentDocument;if(!t)throw new Error("Could not find diagram");if(p=new c(t),_=document.getElementById("editor"),!_)throw new Error("Could not find editor");d(_),_?.focus(),R(),m=document.getElementById("state");let e=document.getElementById("rng-speed");if(e){O=10500-e.valueAsNumber;let t=document.getElementById("freq");t&&(t.innerHTML=`${Math.round(1e6/O)} nHz`)}})),document.getElementById("btn-compile")?.addEventListener("click",R),document.getElementById("btn-run")?.addEventListener("click",(function t(){document.getElementById("btn-pause").disabled=!1,N(),A=setTimeout((()=>{t()}),O)})),document.getElementById("btn-reset")?.addEventListener("click",(function(){f(),p=new c(p.diagramSVG),p.signals(),S()})),document.getElementById("btn-pause")?.addEventListener("click",f),document.getElementById("rng-speed")?.addEventListener("input",(function(){O=10500-document.getElementById("rng-speed")?.valueAsNumber;let t=document.getElementById("freq");t&&(t.innerHTML=`${Math.round(1e6/O)} nHz`),console.log(`timeout: ${O}`)}));
//# sourceMappingURL=index.0cd5bcf0.js.map
